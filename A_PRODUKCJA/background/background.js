alreadystarted=!1,notesofflinemain=null,launched=!0,options={notifications1:!0,autostart1:!1},pwj_pair_code=null,pwj_sync=null,chrome.storage.sync.get(options,function(e){e&&(options=e)}),chrome.storage.onChanged.addListener(function(e,n){if(e.pwj_sync&&(pwj_sync=e.pwj_sync.newValue),e.pwj_pair_code&&(pwj_pair_code=e.pwj_pair_code.newValue),"sync"==n){var o=Object.keys(e);for(i in o)void 0!==options[o[i]]&&(options[o[i]]=e[o[i]].newValue)}}),chrome.app.runtime.onLaunched.addListener(function(){runApp(),updatePurchasedElements(),storeAvailabilityCheck()});var runApp=function(){alreadystarted=!0,console.log("LAUNCH!"),launched=!1,chrome.storage.sync.get({id_owner:null},function(e){if(id_owner=e.id_owner,null===id_owner){var n=new Date;id_owner=n.valueOf()+"_"+Math.random().toString().slice(2),chrome.storage.sync.set({id_owner:id_owner})}}),chrome.storage.sync.get(["pwj_sync","pwj_pair_code"],function(e){e&&e.pwj_sync&&e.pwj_pair_code?(pwj_sync=e.pwj_sync,pwj_pair_code=e.pwj_pair_code):(pwj_sync=!1,pwj_pair_code=null),continueLaunching()})},continueLaunching=function(){var e=indexedDB.open("notes",4);e.onupgradeneeded=function(e){console.log("IndexedDB upgrade needed."),console.log(e);var n=e.target.result;n.onerror=function(e){alert("Database error: "+e.target.errorCode)};try{var o=n.createObjectStore("notes",{keyPath:"id"});o.createIndex("by_id","id",{unique:!0})}catch(e){console.log(e)}},e.onsuccess=function(e){console.log("Success! (1)"),db=this.result,db.onerror=function(e){alert("Database error: "+e.target.errorCode)};var n=null;try{n=db.transaction("notes","readwrite")}catch(e){return console.log(e),!1}var o=n.objectStore("notes"),t=(o.index("by_id"),[]);n.oncomplete=function(e){clearRemovedFromIndexedDB(),pwj_sync&&pwj_pair_code?synchronizeWithPWJ(t):synchronizeWithSyncFileSystem(t),launchNotes(t)};var r=o.openCursor();r.onerror=function(e){console.log(e)},r.onsuccess=function(e){var n=e.target.result;n&&(t.push(n.value),n["continue"]())}},e.onerror=function(e){console.log("Error"),console.dir(e)}},openNewNote=function(e,n){var o=new Date;chrome.app.window.create("/background/note.html",{id:o.valueOf()+"_"+Math.random().toString().slice(2),frame:"none",bounds:{width:250,height:240},resizable:!0},function(o){o.contentWindow.note=null,o.contentWindow.presetcolor=e||null,o.contentWindow.presetfont=n||null,chrome.app.window.get(o.id).onClosed.addListener(function(){syncAll()})})},launchNotes=function(e){e=$.grep(e,function(e,n){return e.removed!==!0?!0:void 0}),null==e||0==e.length?openNewNote():chrome.storage.sync.get("allLaunch",function(n){if(n=n.allLaunch)for(var o in e){var t=e[o];t.removed!==!0&&!function(e){chrome.app.window.create("background/note.html",{id:e.id,frame:"none"},function(n){n.contentWindow.note=e,chrome.app.window.get(e.id).onClosed.addListener(function(){syncAll()})})}(t)}else chrome.app.window.create("background/noteslauncher.html",{id:"notes_launcher",innerBounds:{width:430,height:540},frame:{color:"#8C8C8C"}},function(n){n.contentWindow.notes=e})})},updateDisplayedNotes=function(){var e=chrome.app.window.getAll();for(i in e)e[i].contentWindow.updateNote()},updateDisplayedNote=function(e){if(!e||void 0===e.id)return!1;var n=chrome.app.window.get(e.id);if(n)try{n.contentWindow.updateNote()}catch(o){errorHandler(o)}},syncAllDelayedTimeouted=null,syncAll=function(){clearTimeout(syncAllDelayedTimeouted);var e=indexedDB.open("notes");e.onupgradeneeded=function(n){var o=e.result,t=o.createObjectStore("notes",{keyPath:"id"});t.createIndex("by_id","id",{unique:!0})},e.onsuccess=function(e){console.log("Success! (2)"),db=e.target.result;var n=db.transaction("notes","readwrite"),o=n.objectStore("notes"),t=(o.index("by_id"),[]);n.oncomplete=function(e){pwj_sync&&pwj_pair_code?synchronizeWithPWJ(t):synchronizeWithSyncFileSystem(t)};var r=o.openCursor();r.onerror=function(e){console.log(e)},r.onsuccess=function(e){var n=e.target.result;n&&(t.push(n.value),n["continue"]())}},e.onerror=function(e){console.log("Error"),console.dir(e)}},syncAllDelayed=function(){clearTimeout(syncAllDelayedTimeouted),syncAllDelayedTimeouted=setTimeout(syncAll,1e4)},synchronizeWithPWJ=function(e){var n={};notesofflinemain=e;for(i in e)n[e[i].id]=e[i];$.ajax({url:"http://prowebject.com/stickynotes/web/panel/backend/getNotes.php",dataType:"json",method:"post",data:{pair_code:pwj_pair_code}}).done(function(n){var o={};for(i in e)o[e[i].id]=e[i];var t={};for(i in n)n[i].note_object=JSON.parse(n[i].note_object),n[i].last_update=parseInt(n[i].last_update),!Boolean(n[i].note_object.removed)&&(!o[n[i].note_object.id]||o[n[i].note_object.id].date<n[i].note_object.date||o[n[i].note_object.id].date<n[i].last_update)&&(t[n[i].note_object.id]=n[i].note_object);for(i in o)t[o[i].id]||Boolean(o[i].removed)===!0||(t[o[i].id]=o[i]);saveNotesToIndexedDB(t),sendNotesToPWJ(t)})},sendNotesToPWJ=function(e){var n={notes:e,pair_code:pwj_pair_code,clear:!0};$.ajax({url:"http://prowebject.com/stickynotes/web/panel/backend/putNotes.php",method:"post",dataType:"text",data:n}).done(function(e){clearRemovedFromIndexedDB()})},synchronizeWithSyncFileSystem=function(e){var n=[];notesofflinemain=e;for(i in e)n.push(e[i]);try{chrome.syncFileSystem.requestFileSystem(function(e){requestFileSystemCallback(e,n)})}catch(o){console.log(o)}},requestFileSystemCallback=function(e,n){if(chrome.runtime.lastError||!e)return console.log("NOT SYNCED (filesystem not returned)"),console.log(chrome.runtime.lastError),!1;var o=e.root.createReader(),t=[],r=function(){o.readEntries(function(e){e.length?(useFileEntries(e.sort(),n),t.concat(toArray(e)),r()):useFileEntries(t.sort(),n)},function(e){console.log(e)})};r()},useFileEntries=function(e,n){e.forEach(function(e,o){updateFile(e,n)}),uploadNewNotes(e,n)},uploadNewNotes=function(e,n){for(i in n){var o=n[i].id,t=$.grep(e,function(e,n){return e.name=="note_"+o?!0:void 0});0==t.length&&!function(e){chrome.syncFileSystem.requestFileSystem(function(n){n.root.getFile("note_"+e.id,{create:!0},function(n){writeToFile(n,e)},errorHandler)})}(n[i])}},updateFileSingle=function(e){e.file(function(n){var o=new FileReader;o.onloadend=function(){var n={};try{n=JSON.parse(this.result)}catch(o){errorHandler(o)}if(n&&n.removed)return e.remove(function(){console.log("REMOVED")},errorHandler),!1;if(n){var t=indexedDB.open("notes");t.onsuccess=function(e){db=e.target.result;var o=db.transaction("notes","readwrite"),t=o.objectStore("notes"),r=t.index("by_id"),i=r.get(n.id);i.onsuccess=function(){if(i.result){var e=synchronizeVersions([i.result],n);saveNotesToIndexedDB([e]),isNotesContentSame(n,e)?(updateDisplayedNote(e),options.notifications1&&notifyUpdatedNote(e)):writeToFile(e)}else saveNotesToIndexedDB([n]),options.notifications1&&notifyNewNote(n)}}}},o.readAsText(n)})},updateFile=function(e,n){/note_(\w|_)+/.test(e.name)&&e.file(function(o){var t=new FileReader;t.onloadend=function(){var o;try{o=JSON.parse(this.result)}catch(t){o=null}if(null!==o){var r=synchronizeVersions(n,o);r.removed?e.remove(function(){console.log("REMOVED")},errorHandler):(saveNotesToIndexedDB([r]),isNotesContentSame(o,r)?updateDisplayedNote(r):writeToFile(r))}clearRemovedFromIndexedDB()},t.readAsText(o)})},synchronizeVersions=function(e,n){var o=$.grep(e,function(e,o){return e.id===n.id?!0:void 0}),t={};return t=1==o.length?o[0].date<n.date?n:o[0]:n},writeToFile=function(e,n){e.createWriter(function(e){var o=!1;e.onwriteend=function(e){o||(this.truncate(this.position),o=!0)},e.onerror=function(e){console.log("Write failed: "+e.toString())};var t=new Blob([JSON.stringify(n)],{type:"text/plain"});e.write(t)},function(e){console.log(e.toString())})},toClipboard=function(e,n){$("#clipboardholder").attr("value",e),document.getElementById("clipboardholder").select(),document.oncopy=function(n){n.clipboardData.setData("Text",e),n.preventDefault()};var o=document.execCommand("Copy");document.oncopy=void 0,n({status:o})},clearRemovedFromIndexedDB=function(){var e=indexedDB.open("notes");e.onsuccess=function(e){db=e.target.result;var n=db.transaction("notes","readwrite"),o=n.objectStore("notes"),t=(o.index("by_id"),[]);n.oncomplete=function(e){};var r=o.openCursor();r.onerror=function(e){console.log(e)},r.onsuccess=function(e){var n=e.target.result;n&&(t.push(n.value),n["continue"]());for(i in t)Boolean(t[i].removed)===!0&&o["delete"](t[i].id)}},e.onerror=function(e){console.log("Error"),console.dir(e)}},saveNotesToIndexedDB=function(e){var n=indexedDB.open("notes");n.onsuccess=function(n){db=n.target.result;var o=db.transaction("notes","readwrite"),t=o.objectStore("notes");t.index("by_id");for(var r in e){var i=e[r];i.removed===!0?t["delete"](i.id):t.put(i)}},n.onerror=function(e){console.log("Error"),console.dir(e)}};chrome.syncFileSystem.onFileStatusChanged.addListener(function(e){onFileStatusChanged(e)});var onFileStatusChanged=function(e){/note_(\w|_)+/.test(e.fileEntry.name)&&"remote_to_local"===e.direction?updateFileSingle(e.fileEntry):"purchasedinapp"===e.fileEntry.name&&"remote_to_local"===e.direction&&updatePurchasedElements()};chrome.runtime.onMessage.addListener(function(e,n,o){switch(e.func){case"openNewNote":openNewNote(e.presetcolor,e.presetfont);break;case"syncAll":syncAll();break;case"syncAllDelayed":syncAllDelayed();break;case"toClipboard":toClipboard(e.val,o)}});var storeAvailabilityCheck=function(){google.payments.inapp.getSkuDetails({parameters:{env:"prod"},success:onSkuDetails,failure:onSkuDetailsFail})},setIsStoreOpen=function(e){chrome.storage.local.set({isStoreOpen:e}),setTimeout(function(){storeAvailabilityCheck()},3e4)},onSkuDetails=function(e){try{setIsStoreOpen(e.response.details.inAppProducts.length>0?!0:!1)}catch(n){setIsStoreOpen(!1)}},onSkuDetailsFail=function(e){setIsStoreOpen(!1)},updatePurchasedElements=function(){google.payments.inapp.getPurchases({parameters:{env:"prod"},success:onLicenseUpdate,failure:onLicenseUpdateFail})},onLicenseUpdate=function(e){var n=e.response.details,o=chrome.runtime.id.toString(),t={};for(var r in n)if("ACTIVE"===n[r].state){var i=n[r].sku.split(o+"_inapp").join("");t[i]=!0}t.speech_to_text=!0,chrome.storage.sync.set({purchasedinapp:t})},onLicenseUpdateFail=function(e){chrome.storage.sync.get("purchasedinapp",function(e){var n={};e&&e.purchasedinapp&&(n=e.purchasedinapp),n.speech_to_text=!0,chrome.storage.sync.set({purchasedinapp:n})})};