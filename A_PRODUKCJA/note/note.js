"use strict";var colors=["#FFF","#f7f945","#FEFF87","#87E7FF","#C0A2D8","#8BE48E","#53e3de","#ff9e2b"],color="#FFF",savetimeout=null,hidemenutimeout=null,save=!0;chrome.app.window.current().outerBounds.setMinimumSize(160,160);var sortedMenuItemsReady=!1,speachrecognitionon=!1,speechToTextActiveLang="en-US",purchasedelementslocal={},grabbed=null;$(document).ready(function(){chrome.storage.sync.get(null,function(e){console.log(e)}),updateColor(),setTextarea(),setMenuColors(),setFonts(),setSortedMenuItems(function(){setWindowActions()}),setSpeechToTextLangsList(),setLiveListeners(),setPurchasedItems(),checkStoreState(),$(".sortable").on("dragstart",function(e){grabbed=e.target}),$(".toolbar").on("drop",function(e){e.preventDefault(),$("#customButtonsEndPoint").before(grabbed),grabbed=null,saveNoteDelayed()}).on("dragover",function(e){e.preventDefault()}),$("#noteBox").on("drop",function(e){grabbed&&(e.preventDefault(),$("#menuMenu").append(grabbed),grabbed=null),saveNoteDelayed()}).on("dragover",function(e){grabbed&&e.preventDefault()}),$(".textFormat").click(function(){var e=$(this).data("role");document.execCommand(e,!1,null)}),$("#buttonTaskList").click(function(){document.execCommand("insertUnorderedList",!1,null);var e=$(window.getSelection().focusNode).closest("ul");e.addClass("task-list")}),$(".fontbutton").each(function(){$(this).css("font-family",$(this).attr("font-family")).attr("title",$(this).attr("font-family"))}),$(".fontbutton").click(function(e){$("#noteBox").css("font-family",$(this).attr("font-family")),saveNoteDelayed()}),$(".fontsizebutton").click(function(e){$("#noteBox").css("font-size",parseInt($("#noteBox").css("font-size"))+parseInt($(this).attr("font-size-change"))),saveNoteDelayed()}),$(".menubutton").click(function(e){var o=$(this).attr("menu");$("#"+o).is(":visible")?$(".menucollection").hide("slow"):$(".menucollection").is(":visible")?$(".menucollection").not("#"+o).hide(function(){$("#"+o).show("slow")}):$("#"+o).show("slow")}),$(".menucollection").mouseout(function(){clearTimeout(hidemenutimeout),hidemenutimeout=setTimeout(function(){$(".menucollection").hide("slow")},1500)}),$(".menucollection").mouseover(function(){clearTimeout(hidemenutimeout)}),$("#buttonClose").click(function(e){saveNote(function(){window.close()})}).on("mousedown contextmenu mouseover",function(){showWindowActions()}),$("#windowActionsBox").on("mouseout blur",function(){hideWindowActionsDelayed()}).on("mousein",function(){clearTimeout(hideWindowActionsTimeout)}),$("#buttonMinimize").click(function(){chrome.app.window.current().isMinimized()?chrome.app.window.current().restore():chrome.app.window.current().minimize()}),$("#buttonMaximize").click(function(){chrome.app.window.current().isMaximized()?chrome.app.window.current().restore():chrome.app.window.current().maximize()}),$("#buttonAdd").click(function(e){openNewNote()}),$("#buttonDel").click(function(e){$("#removeBox").fadeIn(200)}),$("#removeCancel").click(function(e){$("#removeBox").fadeOut(300)}),$("#removeRemove").click(function(e){closeThisNote()}),$("#buttonCloseAll").click(function(e){var o=chrome.app.window.getAll();console.log(o);for(var t in o)!function(e){"function"==typeof e.contentWindow.saveNote?e.contentWindow.saveNote(function(){e.close()}):e.close()}(o[t])}),$("#buttonSpeachToText").click(function(e){speechToTextInitiate()}),$("#buttonAlwaysOnTop").click(function(e){var o=chrome.app.window.current().isAlwaysOnTop();chrome.app.window.current().setAlwaysOnTop(!o),buttonYesNoChange(this,!o)}),$("#buttonGoToOptions").click(function(){event.preventDefault(),chrome.app.window.create($(this).attr("href"),{innerBounds:{width:800,height:600}})}),$("#buttonOpenStore").click(function(){event.preventDefault(),chrome.app.window.create($(this).attr("href"),{innerBounds:{width:800,height:600}})}),$("#buttonShareLink").click(function(e){chrome.storage.sync.get("id_owner",function(e){if(e&&e.id_owner){var o=e.id_owner,t={};t.id=note.id,t.textarea=$("#notetextarea").html(),t.color=color,t.fontfamily=$("#noteBox").css("font-family"),t.fontsize=$("#noteBox").css("font-size"),t.date=(new Date).valueOf(),$.post("http://prowebject.com/stickynotes/sharebox/share.php",{id_owner:o,note:t},function(e){if(e){var e=JSON.parse(e);chrome.app.window.create("/background/shared.html",{id:note.id+"_shared",innerBounds:{width:256,height:320,maxWidth:256,maxHeight:320}},function(o){o.contentWindow.info=e;try{o.contentWindow.update()}catch(t){}})}})}})}),$("#colorPalette").on("click",function(e){$("#colorPalette").fadeOut(300)}),$(window).resize(function(){setTextarea(),setSortedMenuItems(function(){setWindowActions()})}),$(window).blur(function(){chrome.runtime.sendMessage({func:"syncAllDelayed"}),hideWindowActions()});try{color=presetcolor,updateColor()}catch(e){}"undefined"!=typeof note&&null!=note?($("#notetextarea").html(note.textarea),color=note.color||"#FFF",updateColor()):(note={},note.id=chrome.app.window.current().id),$("#notetextarea").on("keypress keyup",function(e){saveNoteDelayed()});var o=null,t=!1,n=null,s=null,i=0;$(window).on("keydown keyup",function(e){var c=function(){var e=$("#notetextarea"),i=$("#noteclickarea");if(t===!1){t=!0,n=e.prop("selectionStart"),s=e.prop("selectionEnd");var c=e.html(),a=e.scrollTop(),l=urlize(c,{autoescape:!1});e.hide(),i.show().css("height",e.css("height")).css("width",e.css("width")).html(l).scrollTop(a)}clearTimeout(o),o=setTimeout(r,1500)},r=function(){if(t){clearTimeout(o);var e=$("#notetextarea"),i=$("#noteclickarea"),c=i.scrollTop();i.hide(),e.show().scrollTop(c).prop("selectionStart",n).prop("selectionEnd",s),t=!1}};switch(e.keyCode){case 17:switch(e.type){case"keydown":e.altKey===!1&&i>0?c():i++;break;case"keyup":i=0,r()}break;case 85:"keyup"==e.type&&e.ctrlKey&&e.shiftKey&&document.execCommand("strikeThrough",!1,null);break;case 188:"keydown"==e.type&&e.ctrlKey&&(e.preventDefault(),$("#noteBox").css("font-size",parseInt($("#noteBox").css("font-size"))+1),saveNoteDelayed());break;case 190:"keydown"==e.type&&e.ctrlKey&&(e.preventDefault(),$("#noteBox").css("font-size",parseInt($("#noteBox").css("font-size"))-1),saveNoteDelayed())}}).on("wheel",function(e){e.ctrlKey&&(e.preventDefault(),e.originalEvent.deltaY>0?$("#noteBox").css("font-size",parseInt($("#noteBox").css("font-size"))-1):e.originalEvent.deltaY<0&&$("#noteBox").css("font-size",parseInt($("#noteBox").css("font-size"))+1),saveNoteDelayed())}),$("#notetextarea").on("keydown",function(e){switch(e.keyCode){case 9:e.preventDefault(),insertElem($(document.createElement("pre")).addClass("pretab").append("&#9;")[0])}}),chrome.app.window.onClosed.addListener(function(){save&&saveNote()}),buttonYesNoChange($("#buttonAlwaysOnTop")[0],chrome.app.window.current().isAlwaysOnTop()),saveNote()}),chrome.storage.onChanged.addListener(function(e,o){null!==e.sortedMenuItems&&setSortedMenuItems(function(){setWindowActions()}),null!==e.purchasedinapp&&void 0!==e.purchasedinapp&&setPurchasedItems(),null!==e.isStoreOpen&&void 0!==e.isStoreOpen&&setStoreState(e.isStoreOpen.newValue)});var hideWindowActionsTimeout=null,setWindowActions=function(){25*$("#toolbar > .button, #windowActionsBox > .button").length<=$(window).width()?($("#windowActionsBox").removeClass("windowActionsBoxDrop").addClass("windowActionBoxToolbar"),$("#buttonClose").after($("#windowActionsBox"))):($("#windowActionsBox").removeClass("windowActionBoxToolbar").addClass("windowActionsBoxDrop"),$("body").append($("#windowActionsBox")))},setLiveListeners=function(){$("body").on("dblclick","ul.task-list li",function(e){e.preventDefault(),e.stopPropagation(),$(this).hasClass("done")===!0?$(this).removeClass("done"):$(this).addClass("done");var o=window.getSelection();o.removeAllRanges()}),$("body").on("dblclick","ul.task-list li span",function(e){e.preventDefault(),e.stopPropagation()})},showWindowActions=function(){$("#windowActionsBox").is(":visible")||$("#windowActionsBox").show("fast")},markButtonCloseAsSaved=function(){$("#buttonClose").removeClass("buttonclosesaveon buttonclosesaveon-delayed").attr("title","Saved, click to Hide!")},hideWindowActionsDelayed=function(){clearTimeout(hideWindowActionsTimeout),hideWindowActionsTimeout=setTimeout(function(){hideWindowActions()},1500)},hideWindowActions=function(){clearTimeout(hideWindowActionsTimeout),$("#windowActionsBox").hide("fast")},setSpeechToTextLangsList=function(){for(var e in speechToTextLangs){var o=speechToTextLangs[e];if(2===o.length)$("#speechToTextLangSelBox>ul").append('<li code="'+o[1]+'">'+o[0]+"</li>");else if(o.length>2)for(var t=1;t<o.length;t++){var n=o[t];$("#speechToTextLangSelBox>ul").append('<li code="'+n[0]+'">'+o[0]+" ("+n[1]+")</li>")}}$("#speechToTextLangSelBox>ul>li").click(function(){var e=$(this).attr("code");chrome.storage.sync.set({speechToTextLang:e},function(){}),$("#speechToTextLangSelBox").fadeOut(300)})},speechToTextInitiate=function(){var e=function(){speachrecognitionon===!0?speechToTextOff():chrome.storage.sync.get("speechToTextLang",function(e){console.log(e),e=e.speechToTextLang,e?(speechToTextActiveLang=e,speechToTextOn()):$("#speechToTextLangSelBox").fadeIn(200)})};chrome.permissions.request({permissions:["audioCapture"]},function(o){o&&e()})},recognition,speechToTextOn=function(){if(console.log("try"),"webkitSpeechRecognition"in window){speachrecognitionon=!0,console.log("on");try{recognition=recognition||new webkitSpeechRecognition}catch(e){recognition=new webkitSpeechRecognition}recognition.continuous=!0,recognition.interimResults=!0,recognition.lang=speechToTextActiveLang,recognition.onstart=function(){$("#buttonSpeachToText").addClass("speachToTextOn")},recognition.onresult=function(e){$("#pendingOperations1").show();for(var o="",t="",n=saveSelection(),s=e.resultIndex;s<e.results.length;++s)e.results[s].isFinal?t+=e.results[s][0].transcript:o+=e.results[s][0].transcript;""!==t.trim()&&!function(e,o){e&&insertText(o,e),$("#pendingOperations1").hide(),saveNoteDelayed()}(n,t)},recognition.onerror=function(e){console.log("ERR"),console.log(e.error)},recognition.onend=function(){$("#pendingOperations1").hide(),speachrecognitionon===!0&&recognition.start()},navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,navigator.getUserMedia({audio:!0},function(e){recognition.start()},function(e){console.log("DENIED"),console.log(e)})}},speechToTextOff=function(){$("#buttonSpeachToText").removeClass("speachToTextOn"),speachrecognitionon=!1,recognition.stop()},setSortedMenuItems=function(e){chrome.storage.sync.get({sortedMenuItems:null},function(o){for(null!==o.sortedMenuItems&&o.sortedMenuItems.length>0?($("#menuMenu").append($("#toolbar > .sortable").not("#"+o.sortedMenuItems.join(",#"))),$("#customButtonsEndPoint").before($("#"+o.sortedMenuItems.join(",#")))):$("#menuMenu").append($("#toolbar > .sortable")),sortedMenuItemsReady=!0;25*$("#toolbar > .button").length>$(window).width()-20&&$("#customButtonsEndPoint").prev(".sortable").length>0;)$("#menuMenu").append($("#customButtonsEndPoint").prev(".sortable")),sortedMenuItemsReady=!1;"function"==typeof e&&e()})},buttonYesNoChange=function(e,o){o?$(e).removeClass("buttonNo").addClass("buttonYes"):$(e).removeClass("buttonYes").addClass("buttonNo")},updateColor=function(e,o){var t=color;"undefined"!=typeof o&&(t=o),"undefined"==typeof e&&(e=!0),"number"==typeof t&&(t=colors[t]),$(".globalBox").css("background-color",t),$("#buttonColor .dot").css("background-color",t),e&&saveNoteDelayed()},openNewNote=function(){chrome.runtime.sendMessage({func:"openNewNote",presetcolor:color,presetfont:{fontfamily:$("#noteBox").css("font-family"),fontsize:$("#noteBox").css("font-size")}})},closeThisNote=function(){var e=indexedDB.open("notes");e.onsuccess=function(e){var o=e.target.result,t=o.transaction("notes","readwrite"),n=t.objectStore("notes");n.index("by_id");n.put({id:note.id,removed:!0,date:(new Date).valueOf()}).onsuccess=function(e){chrome.runtime.sendMessage({func:"syncAllDelayed"}),save=!1,chrome.app.window.current().close()}},e.onerror=function(e){console.log("Error"),console.dir(e)}},setTextarea=function(){var e=$(window).height()-10,o=$(window).width()-10;e-=$("#notetextarea").position().top,$("#noteBox>*").css("height",e),$("#noteBox>*").css("width",o)},setFonts=function(){try{$("#noteBox").css("font-family",presetfont.fontfamily)}catch(e){}try{$("#noteBox").css("font-size",presetfont.fontsize)}catch(e){}note&&($("#noteBox").css("font-family",note.fontfamily),$("#noteBox").css("font-size",note.fontsize))},setMenuColors=function e(){$("#menuColors").empty();for(var o in colors)$("#menuColors").append('<div class="button left colorbutton" data-color="'+colors[o]+'" style="" title="Set this color!"><div class="dot" style="width:13px;height:13px;margin:6px;background-color:'+colors[o]+';"></div></div>');$(".colorbutton").on("click",function(){color=$(this).data("color"),updateColor(),e()}),$("#menuColors").append('<div class="button left colorbutton storedependent" id="BuyBgColors" style="" title="Get more colors!"><div class="dot" style="width:13px;height:13px;margin:6px;background-color:#000000; animation:multicolor 5s infinite linear"></div></div>'),$("#BuyBgColors").on("click",function(e){chrome.app.window.create("store/purchase.html#bgcolors",{innerBounds:{width:800,height:600}})}),purchasedelementslocal.color_palette_background&&($("#menuColors").append('<div class="button left buttoncolormap" id="openBackgroundPalette" style="" title="Choose from the palette!"></div>'),$("#openBackgroundPalette").on("click",function(e){openBackgroundPalette()}))},openBackgroundPalette=function(){$("#colorPalette").fadeIn(200),$("#colormap>area").on("click",function(e){color=$(this).attr("alt"),updateColor()}).on("mouseover",function(e){updateColor(!1,$(this).attr("alt"))}),$("#colormap").on("mouseout",function(e){updateColor()})},setSnippet=function(){document.title=$("#notetextarea").text().slice(0,40)},saveNoteDelayedTimeout=null,changesInProgress=!1,saveNoteDelayed=function(){changesInProgress=!0,$("#buttonClose").addClass("buttonclosesaveon-delayed").attr("title","Changes detected, stop typing to autosave :)"),clearTimeout(saveNoteDelayedTimeout),saveNoteDelayedTimeout=setTimeout(saveNote,700)},saveNote=function(e){$("#buttonClose").removeClass("buttonclosesaveon-delayed").attr("title","Saving!");var o=$("#notetextarea").html();if(sortedMenuItemsReady){var t=$(".toolbar > .sortable").toArray();for(var n in t)t[n]=t[n].id;chrome.storage.sync.set({sortedMenuItems:t},function(){setSortedMenuItems(function(){setWindowActions()})})}setSnippet();var s=indexedDB.open("notes");s.onsuccess=function(n){var s=n.target.result,i=s.transaction("notes","readwrite"),c=i.objectStore("notes"),r=c.index("by_id"),a=r.get(note.id);a.onsuccess=function(){if(void 0===a.result){var n={};n.id=note.id,n.textarea=o,n.width=$(window).width(),n.height=$(window).height(),n.top=window.screenY,n.left=window.screenX,n.color=color,n.fontfamily=$("#noteBox").css("font-family"),n.fontsize=$("#noteBox").css("font-size"),n.date=(new Date).valueOf(),n.sortedMenuItems=t;var s=c.put(n);s.onsuccess=function(){note=n,markButtonCloseAsSaved(),chrome.runtime.sendMessage({func:"syncAllDelayed"}),e&&e()},changesInProgress=!1}else{var i=JSON.parse(JSON.stringify(a.result));if(a.result.textarea=o,a.result.width=$(window).width(),a.result.height=$(window).height(),a.result.top=window.screenY,a.result.left=window.screenX,a.result.color=color,a.result.fontfamily=$("#noteBox").css("font-family"),a.result.fontsize=$("#noteBox").css("font-size"),a.result.sortedMenuItems=t,isNotesContentSame(i,a.result)===!0)markButtonCloseAsSaved(),e&&e();else{a.result.date=(new Date).valueOf(),console.log("UPDATED");var s=c.put(a.result);s.onsuccess=function(){note=a.result,markButtonCloseAsSaved(),chrome.runtime.sendMessage({func:"syncAllDelayed"}),e&&e()}}changesInProgress=!1}}},s.onerror=function(e){console.log("Error"),console.dir(e)}},updateNote=function(){var e=indexedDB.open("notes");e.onsuccess=function(e){var o=e.target.result,t=o.transaction("notes","readwrite"),n=t.objectStore("notes"),s=n.index("by_id"),i=s.get(note.id);i.onsuccess=function(){if(i&&i.result){var e=i.result;changesInProgress===!1&&isNotesContentSame(e,note)!==!0&&e.date>note.date&&(note=e,$("#notetextarea").html(note.textarea),color=note.color,updateColor(),setTextarea(),setMenuColors(),setFonts(),setSnippet())}}},e.onerror=function(e){console.log("Error"),console.dir(e)}},checkStoreState=function(){chrome.storage.local.get("isStoreOpen",function(e){e&&setStoreState(e.isStoreOpen)})},setStoreState=function(e){e?$(".storedependent").removeClass("offcosnostore"):$(".storedependent").addClass("offcosnostore")},setPurchasedItems=function(){chrome.storage.sync.get("purchasedinapp",function(e){if(e&&e.purchasedinapp){var o=e.purchasedinapp,t=!1;for(var n in o)if(console.log(n),console.log(o[n]),o[n]===!0)if(/^color_box_background_.+/.test(n)!==!0)switch(n){case"color_palette_background":purchasedelementslocal.color_palette_background=!0,t=!0;break;case"color_background_454f56":addOptionalBgColor("#"+n.split("color_background_").join("")),t=!0;break;case"color_background_ff7171":addOptionalBgColor("#"+n.split("color_background_").join("")),t=!0;break;case"color_background_ff4fc1":addOptionalBgColor("#"+n.split("color_background_").join("")),t=!0;break;case"speech_to_text":$("#buttonSpeachToText").css("display","block")}else{if(inAppProducts[n]&&inAppProducts[n].colors)for(var s in inAppProducts[n].colors)addOptionalBgColor(inAppProducts[n].colors[s]);t=!0}t&&setMenuColors()}})},addOptionalBgColor=function(e){-1===colors.indexOf(e)&&colors.push(e)};