alreadystarted=!1,notesofflinemain=null,launched=!0,options={notifications1:!0,autostart1:!1},chrome.storage.sync.get(options,function(e){e&&(options=e)}),chrome.storage.onChanged.addListener(function(e,o){if("sync"==o){var n=Object.keys(e);for(i in n)void 0!==options[n[i]]&&(options[n[i]]=e[n[i]].newValue)}}),chrome.app.runtime.onLaunched.addListener(function(){runApp(),getShopData()});var runApp=function(){alreadystarted=!0,console.log("LAUNCH!"),launched=!1,chrome.storage.sync.get({id_owner:null},function(e){if(id_owner=e.id_owner,null===id_owner){var o=new Date;id_owner=o.valueOf()+"_"+Math.random().toString().slice(2),chrome.storage.sync.set({id_owner:id_owner})}});var e=indexedDB.open("notes",4);e.onupgradeneeded=function(e){console.log("IndexedDB upgrade needed."),console.log(e);var o=e.target.result;o.onerror=function(e){alert("Database error: "+e.target.errorCode)};try{var n=o.createObjectStore("notes",{keyPath:"id"});n.createIndex("by_id","id",{unique:!0})}catch(e){console.log(e)}},e.onsuccess=function(e){console.log("Success! (1)"),console.log(e),db=this.result,db.onerror=function(e){alert("Database error: "+e.target.errorCode)};var o=null;try{o=db.transaction("notes","readwrite")}catch(e){return console.log(e),!1}var n=o.objectStore("notes"),t=(n.index("by_id"),[]);o.oncomplete=function(e){console.log(t),clearRemovedFromIndexedDB(),synchronizeWithSyncFileSystem(t),launchNotes(t)};var r=n.openCursor();r.onerror=function(e){console.log(e)},r.onsuccess=function(e){var o=e.target.result;o&&(t.push(o.value),o["continue"]())}},e.onerror=function(e){console.log("Error"),console.dir(e)}},openNewNote=function(e,o){var n=new Date;chrome.app.window.create("/background/note.html",{id:n.valueOf()+"_"+Math.random().toString().slice(2),frame:"none",bounds:{width:250,height:240},resizable:!0},function(n){n.contentWindow.note=null,n.contentWindow.presetcolor=e||null,n.contentWindow.presetfont=o||null,chrome.app.window.get(n.id).onClosed.addListener(function(){syncAll()})})},launchNotes=function(e){e=$.grep(e,function(e,o){return e.removed!==!0?!0:void 0}),console.log(e),null==e||0==e.length?openNewNote():chrome.storage.sync.get("allLaunch",function(o){if(o=o.allLaunch)for(var n in e){var t=e[n];t.removed!==!0&&!function(e){chrome.app.window.create("background/note.html",{id:e.id,frame:"none"},function(o){o.contentWindow.note=e,chrome.app.window.get(e.id).onClosed.addListener(function(){syncAll()})})}(t)}else chrome.app.window.create("background/noteslauncher.html",{id:"notes_launcher",innerBounds:{width:430,height:540}},function(o){o.contentWindow.notes=e})})},updateDisplayedNotes=function(){var e=chrome.app.window.getAll();for(i in e)e[i].contentWindow.updateNote()},updateDisplayedNote=function(e){if(!e||void 0===e.id)return!1;var o=chrome.app.window.get(e.id);if(o)try{o.contentWindow.updateNote()}catch(n){console.log(e.id),errorHandler(n)}},syncAllDelayedTimeouted=null,syncAll=function(){clearTimeout(syncAllDelayedTimeouted);var e=indexedDB.open("notes");e.onupgradeneeded=function(o){var n=e.result,t=n.createObjectStore("notes",{keyPath:"id"});t.createIndex("by_id","id",{unique:!0})},e.onsuccess=function(e){console.log("Success! (2)"),db=e.target.result;var o=db.transaction("notes","readwrite"),n=o.objectStore("notes"),t=(n.index("by_id"),[]);o.oncomplete=function(e){synchronizeWithSyncFileSystem(t)};var r=n.openCursor();r.onerror=function(e){console.log(e)},r.onsuccess=function(e){var o=e.target.result;o&&(t.push(o.value),o["continue"]())}},e.onerror=function(e){console.log("Error"),console.dir(e)}},syncAllDelayed=function(){clearTimeout(syncAllDelayedTimeouted),syncAllDelayedTimeouted=setTimeout(syncAll,1e4)},synchronizeWithSyncFileSystem=function(e){var o=[];notesofflinemain=e;for(i in e)o.push(e[i]);try{chrome.syncFileSystem.requestFileSystem(function(e){requestFileSystemCallback(e,o)})}catch(n){console.log(n)}},requestFileSystemCallback=function(e,o){if(chrome.runtime.lastError||!e)return console.log("NOT SYNCED (filesystem not returned)"),console.log(chrome.runtime.lastError),!1;var n=e.root.createReader(),t=[],r=function(){n.readEntries(function(e){e.length?(useFileEntries(e.sort(),o),t.concat(toArray(e)),r()):useFileEntries(t.sort(),o)},function(e){console.log(e)})};r()},useFileEntries=function(e,o){e.forEach(function(e,n){updateFile(e,o)}),uploadNewNotes(e,o)},uploadNewNotes=function(e,o){for(i in o){var n=o[i].id,t=$.grep(e,function(e,o){return e.name=="note_"+n?!0:void 0});0==t.length&&!function(e){chrome.syncFileSystem.requestFileSystem(function(o){o.root.getFile("note_"+e.id,{create:!0},function(o){writeToFile(o,e)},errorHandler)})}(o[i])}},updateFileSingle=function(e){e.file(function(o){var n=new FileReader;n.onloadend=function(){var o={};try{o=JSON.parse(this.result)}catch(n){errorHandler(n)}if(o&&o.removed)return e.remove(function(){console.log("REMOVED")},errorHandler),!1;if(o){var t=indexedDB.open("notes");t.onsuccess=function(e){db=e.target.result;var n=db.transaction("notes","readwrite"),t=n.objectStore("notes"),r=t.index("by_id"),i=r.get(o.id);i.onsuccess=function(){if(i.result){var e=synchronizeVersions([i.result],o);saveNotesToIndexedDB([e]),isNotesContentSame(o,e)?(updateDisplayedNote(e),options.notifications1&&notifyUpdatedNote(e)):writeToFile(e)}else saveNotesToIndexedDB([o]),options.notifications1&&notifyNewNote(o)}}}},n.readAsText(o)})},updateFile=function(e,o){/note_(\w|_)+/.test(e.name)&&e.file(function(n){var t=new FileReader;t.onloadend=function(){var n;try{n=JSON.parse(this.result)}catch(t){n=null}if(console.log(n),null!==n){var r=synchronizeVersions(o,n);r.removed?e.remove(function(){console.log("REMOVED")},errorHandler):(saveNotesToIndexedDB([r]),isNotesContentSame(n,r)?updateDisplayedNote(r):writeToFile(r))}clearRemovedFromIndexedDB()},t.readAsText(n)})},synchronizeVersions=function(e,o){var n=$.grep(e,function(e,n){return e.id===o.id?!0:void 0}),t={};return t=1==n.length?n[0].date<o.date?o:n[0]:o},writeToFile=function(e,o){e.createWriter(function(e){var n=!1;e.onwriteend=function(e){n||(this.truncate(this.position),n=!0)},e.onerror=function(e){console.log("Write failed: "+e.toString())};var t=new Blob([JSON.stringify(o)],{type:"text/plain"});e.write(t)},function(e){console.log(e.toString())})},toClipboard=function(e,o){$("#clipboardholder").attr("value",e),document.getElementById("clipboardholder").select(),document.oncopy=function(o){console.log(e),o.clipboardData.setData("Text",e),o.preventDefault()},console.log(e);var n=document.execCommand("Copy");document.oncopy=void 0,console.log(n),o({status:n})},clearRemovedFromIndexedDB=function(){var e=indexedDB.open("notes");e.onsuccess=function(e){db=e.target.result;var o=db.transaction("notes","readwrite"),n=o.objectStore("notes"),t=(n.index("by_id"),[]);o.oncomplete=function(e){};var r=n.openCursor();r.onerror=function(e){console.log(e)},r.onsuccess=function(e){var o=e.target.result;o&&(t.push(o.value),o["continue"]());for(i in t)t[i].removed===!0&&n["delete"](t[i].id)}},e.onerror=function(e){console.log("Error"),console.dir(e)}},saveNotesToIndexedDB=function(e){var o=indexedDB.open("notes");o.onsuccess=function(o){db=o.target.result;var n=db.transaction("notes","readwrite"),t=n.objectStore("notes");t.index("by_id");for(var r in e){var i=e[r];i.removed===!0?t["delete"](i.id):t.put(i)}},o.onerror=function(e){console.log("Error"),console.dir(e)}},getShopData=function(){google.payments.inapp.getSkuDetails({parameters:{env:"prod"},success:function(e){console.log("SHOP OK:"),console.log(e)},failure:function(e){console.log("SHOP ERR:"),console.log(e)}})};chrome.syncFileSystem.onFileStatusChanged.addListener(function(e){onFileStatusChanged(e)});var onFileStatusChanged=function(e){/note_(\w|_)+/.test(e.fileEntry.name)&&"remote_to_local"===e.direction&&updateFileSingle(e.fileEntry)};chrome.runtime.onMessage.addListener(function(e,o,n){switch(e.func){case"openNewNote":openNewNote(e.presetcolor,e.presetfont);break;case"syncAll":syncAll();break;case"syncAllDelayed":syncAllDelayed();break;case"toClipboard":toClipboard(e.val,n)}});